steps:
  # Etapa 1: Build da imagem Docker
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/api-grupo-boticario:latest', '.']

  # Etapa 2: Teste da aplicação
  - name: 'gcr.io/cloud-builders/docker'
    args: ['run', '--rm', 'gcr.io/$PROJECT_ID/api-grupo-boticario:latest', 'npm', 'test']

  # Etapa 3: Push da imagem para o Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/api-grupo-boticario:latest']

  # Etapa 4: Obtenção de credenciais para o Kubernetes
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud container clusters get-credentials autopilot-cluster-1 --region=us-central1 --project=$PROJECT_ID --quiet
    env:
      - 'CLOUDSDK_COMPUTE_REGION=us-central1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=autopilot-cluster-1'
      - 'KUBECTL_VERSION=1.30'  # Definindo a versão do kubectl

  # Etapa 5: Implantação no Kubernetes
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - 'apply'
      - '-f'
      - 'kubernetes/deployment.yaml'
      - '-f'
      - 'kubernetes/service.yaml'
      - '-f'
      - 'kubernetes/ingress.yaml'

  # Etapa 6: Verificação do status da implantação
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/api-grupo-boticario'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=us-central1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=autopilot-cluster-1'

timeout: '1200s'  # Timeout para o processo de build (20 minutos)
options:
  logging: CLOUD_LOGGING_ONLY
